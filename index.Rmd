---
title: "Examining Demographic Patterns in NYC Shooting Data"
output: 
  html_document:
    css: bootstrap.min.css
    toc: true
    toc_float: true
---

Welcome!

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,  
  message = FALSE   
)
```

```{r}
library(tidyverse)
library(plotly)
```

```{r}
incidents_data <- read.csv("data_final.csv")

incidents_filtered <- incidents_data %>%
  filter(Year >= 2017 & Year <= 2023)

#Aggregate total incidents by CDTA
incidents_by_cdta <- incidents_filtered %>%
  group_by(CDTA) %>%
  summarise(
    total_incidents = n(),
    Longitude = mean(Longitude, na.rm = TRUE),
    Latitude = mean(Latitude, na.rm = TRUE)
  ) %>%
  ungroup()

# Define initial breaks from 0 to 400 with intervals of 5
initial_breaks <- seq(0, 400, by = 5)

# Calculate the maximum number of incidents
max_incidents <- max(incidents_by_cdta$total_incidents, na.rm = TRUE)

# Check if maximum incidents exceed 400 and adjust breaks and labels accordingly
if (max_incidents > 400) {
  # Extend breaks to include all incidents > 400
  extended_breaks <- c(initial_breaks, Inf)
  
  # Create labels for all intervals, including the last one for incidents >400
  labels <- c(
    paste(initial_breaks[-length(initial_breaks)], initial_breaks[-1], sep = "-"),
    paste0("401-", max_incidents)
  )
} else {
  # No need to extend breaks
  extended_breaks <- initial_breaks
  labels <- paste(initial_breaks[-length(initial_breaks)], initial_breaks[-1], sep = "-")
}

# Validate that the number of labels matches the number of intervals
num_intervals <- length(extended_breaks) - 1
num_labels <- length(labels)

if (num_intervals != num_labels) {
  stop("Number of labels does not match the number of intervals.")
}

# Assign incident ranges
incidents_by_cdta <- incidents_by_cdta %>%
  mutate(
    incident_range = cut(
      total_incidents,
      breaks = extended_breaks,
      include.lowest = TRUE,
      right = FALSE,  # Left-inclusive intervals [a, b)
      labels = labels
    )
  )

# Check for missing coordinates and exclude them
missing_coords <- incidents_by_cdta %>%
  filter(is.na(Longitude) | is.na(Latitude))

if (nrow(missing_coords) > 0) {
  cat("Warning: The following CDTAs have missing coordinates and will be excluded from the plot:\n")
  print(missing_coords$CDTA)
  
  # Exclude CDTAs with missing coordinates
  incidents_by_cdta <- incidents_by_cdta %>%
    filter(!is.na(Longitude) & !is.na(Latitude))
}

Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiZWR3YXJkenp6IiwiYSI6ImNtNDkwMzZ3YTA1MGIyanE1ZjdlNTZodjcifQ.BsLSffH3a0z5Xqf1Tqc4ag')  

# Create the scatter map
incident_map <- plot_ly(
  data = incidents_by_cdta,
  type = "scattermapbox",
  mode = "markers",
  lon = ~Longitude,  
  lat = ~Latitude,   
  color = ~incident_range,
  colors = "viridis",  
  marker = list(
    size = 8,
    opacity = 0.7
  ),
  text = ~paste(
    "CDTA: ", CDTA,
    "<br>Total Incidents: ", total_incidents,
    "<br>Incident Range: ", incident_range
  )
) %>%
  layout(
    title = "Total Number of Incidents Across NYC CDTAs (2017-2023)",
    mapbox = list(
      style = "carto-positron",  # Choose desired map style
      center = list(lon = -73.95, lat = 40.74),  # Centered on NYC
      zoom = 9.5
    ),
    legend = list(title = list(text = 'Incident Range'))
  )

incident_map
```