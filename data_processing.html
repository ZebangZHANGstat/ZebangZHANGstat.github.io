<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />



<meta name="date" content="2024-12-05" />

<title>data_processing</title>

<script src="site_libs/header-attrs-2.28/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="bootstrap.min.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="descriptive_statistics.html">Distribution</a>
</li>
<li>
  <a href="Poverty.html">Sociodemographic</a>
</li>
<li>
  <a href="boro_nta.html">Distribution on the Map</a>
</li>
<li>
  <a href="https://zz3309.shinyapps.io/nyc_shooting_incident_shiny_dashboard/">Shiny App</a>
</li>
<li>
  <a href="mailto:&lt;zz3309@cumc.columbia.edu&gt;">
    <span class="fa fa-envelope fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://github.com/ZebangZHANGstat/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">data_processing</h1>
<h4 class="date">2024-12-05</h4>

</div>


<pre class="r"><code>library(sf)
library(dplyr)
library(readr)
library(stringr)
library(lubridate)
library(timeDate)
library(suncalc)
library(purrr)
library(readxl)
library(tidyverse)</code></pre>
<div id="data-source" class="section level1">
<h1>Data source</h1>
<div id="original-data" class="section level2">
<h2>Original data</h2>
<p>This report analyzes shooting incidents in NYC. You can find the
original data before merging <a
href="https://data.cityofnewyork.us/Public-Safety/NYPD-Shooting-Incident-Data-Historic-/833y-fsy8/about_data">here</a>.
This data is from NYCOpenData, consists some basic information: occur
time, coordinate of each incident, victim’s information, .etc.</p>
</div>
<div id="data-for-additional-information" class="section level2">
<h2>data for additional information</h2>
<div id="nta-shape-data" class="section level3">
<h3>NTA shape data</h3>
<p>Neighborhood Tabulation Areas (NTAs) are medium-sized statistical
geographies for reporting Decennial Census and American Community
Survey. NTAs were delineated with the need for both geographic
specificity and statistical reliability in mind. Shapefile of NTA is get
from NYC Planning website, you can find the data <a
href="https://www.nyc.gov/site/planning/data-maps/open-data/census-download-metadata.page">here</a>,
or you can <a
href="https://s-media.nyc.gov/agencies/dcp/assets/files/zip/data-tools/bytes/nynta2020_24d.zip">download</a></p>
</div>
<div id="cdta-data" class="section level3">
<h3>CDTA data</h3>
<p>The Department of City Planning (DCP) created Community District
Tabulation Areas (CDTAs) to closely approximate the 59 Community
Districts of New York City for the purpose of reporting American
Community Survey (ACS) data. You can find the data <a
href="https://www.nyc.gov/site/planning/data-maps/open-data/census-download-metadata.page">here</a>,
or you can <a
href="https://s-media.nyc.gov/agencies/dcp/assets/files/zip/data-tools/bytes/nycdta2020_24d.zip">download</a></p>
</div>
<div id="borough-boundaries-data" class="section level3">
<h3>Borough Boundaries data</h3>
<p>The Borough Boundaries dataset from the NYC Open Data portal provides
detailed information about the geographical boundaries of the five
boroughs of New York City: Bronx, Brooklyn, Manhattan, Queens, and
Staten Island. You can find the data <a
href="https://data.cityofnewyork.us/City-Government/Borough-Boundaries/tqmj-j8zm">here</a></p>
</div>
<div id="neighborhood-data" class="section level3">
<h3>Neighborhood data</h3>
<p><a
href="https://data.insideairbnb.com/united-states/ny/new-york-city/2024-09-04/visualisations/neighbourhoods.csv">Here</a>
is neighbourhood list for geo filter. Sourced from city or open source
GIS files. <a
href="https://data.insideairbnb.com/united-states/ny/new-york-city/2024-09-04/visualisations/neighbourhoods.geojson">Here</a>
is GeoJSON file of neighbourhoods of the city.</p>
</div>
<div id="education-data" class="section level3">
<h3>Education data</h3>
<p>The data source for education is shown <a
href="https://a816-dohbesp.nyc.gov/IndicatorPublic/data-explorer/social-conditions/?id=2334#display=summary">here</a>.</p>
</div>
<div id="poverty-data" class="section level3">
<h3>Poverty data</h3>
<p>The data source for poverty is <a
href="https://a816-dohbesp.nyc.gov/IndicatorPublic/data-explorer/economic-conditions/?id=103#display=summary">here</a></p>
</div>
</div>
</div>
<div id="data-processing" class="section level1">
<h1>Data processing</h1>
<p>The original <a
href="https://data.cityofnewyork.us/Public-Safety/NYPD-Shooting-Incident-Data-Historic-/833y-fsy8/about_data">data</a>
only consists of some basic information and doesn’t show NTA, CDTA,
Borough and neighborhood information of each incident, so we added these
information to the original data base on the coordinate of each
incident, we also add some demographic information: population,
education level, poverty level, .etc to the data.</p>
<p>Here’s how we added the information based on all the data we
have:</p>
<ul>
<li><p>enrich NYC shooting incident data with neighborhood-level
information by performing spatial operations, converts the shooting data
into a spatial format, joins it with neighborhood boundaries, and adds
additional neighborhood attributes for deeper spatial analysis.</p></li>
<li><p>enrich NYC shooting incident data with neighborhood-level
information by performing spatial operations, converts the shooting data
into a spatial format, joins it with neighborhood boundaries (both 2020
and 2010 shapefiles), and adds additional neighborhood attributes for
deeper spatial analysis.</p></li>
<li><p>using the <code>holidayNYSE()</code> function to determine which
dates are public holidays</p></li>
<li><p>calculates dawn and dusk times for each unique date in the
dataset. Using NYC’s coordinates (<code>latitude</code> and
<code>longitude</code>), the <code>getSunlightTimes()</code> function
generates dawn and dusk times for each day</p></li>
<li><p>reads in population data from an Excel file, filters relevant
rows, selects specific columns, and merges this population data with the
original dataset.</p></li>
<li><p>filters the poverty and education data for the relevant time
period (2017-21) and geographic type (<code>NTA2020</code>), selects
specific columns, and merges this poverty data with the shooting
incident dataset.</p></li>
<li><p>calculates shooting incident rates for both Neighborhood
Tabulation Areas (NTAs) and boroughs by year.</p></li>
</ul>
<div id="adding-neighborhood-information-to-the-shooting-dataset"
class="section level2">
<h2>adding neighborhood information to the shooting dataset</h2>
<pre class="r"><code>df=read_csv(&quot;./data/NYPD_Shooting_Incident_Data__Historic__20241119.csv&quot;)

# Ensure coordinate columns are numeric
df = df %&gt;%
  mutate(
    X_COORD_CD = as.numeric(X_COORD_CD),
    Y_COORD_CD = as.numeric(Y_COORD_CD)
  )

# Convert to sf object with CRS EPSG:2263
df_sf = st_as_sf(df, coords = c(&quot;X_COORD_CD&quot;, &quot;Y_COORD_CD&quot;), crs = 2263)

# Download and read the GeoJSON file
download.file(
  url = &quot;https://data.insideairbnb.com/united-states/ny/new-york-city/2024-09-04/visualisations/neighbourhoods.geojson&quot;,
  destfile = &quot;neighbourhoods.geojson&quot;,
  mode = &quot;wb&quot;
)
neighbourhoods = st_read(&quot;neighbourhoods.geojson&quot;)</code></pre>
<pre><code>## Reading layer `neighbourhoods&#39; from data source 
##   `/Users/wangmingyin/Desktop/data science 1/Final_website/neighbourhoods.geojson&#39; 
##   using driver `GeoJSON&#39;
## Simple feature collection with 233 features and 2 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -74.25559 ymin: 40.49613 xmax: -73.70782 ymax: 40.91553
## Geodetic CRS:  WGS 84</code></pre>
<pre class="r"><code># Check and transform CRS of neighborhoods
if (st_crs(neighbourhoods)$epsg != 2263) {
  neighbourhoods = st_transform(neighbourhoods, crs = 2263)
}

# Perform the spatial join
df_joined = st_join(df_sf, neighbourhoods, left = TRUE)

# Add neighborhood information to the data frame
df$Neighborhood = df_joined$neighbourhood

# Download and use the neighborhoods CSV file
download.file(
  url = &quot;https://data.insideairbnb.com/united-states/ny/new-york-city/2024-09-04/visualisations/neighbourhoods.csv&quot;,
  destfile = &quot;neighbourhoods.csv&quot;,
  mode = &quot;wb&quot;
)
neighborhoods_csv = read_csv(&quot;neighbourhoods.csv&quot;)

# Merge additional attributes if necessary
df = df %&gt;%
  left_join(neighborhoods_csv, by = c(&quot;Neighborhood&quot; = &quot;neighbourhood&quot;))</code></pre>
<p>converts the shooting data into a spatial format, joins it with
neighborhood boundaries, and adds additional neighborhood attributes for
deeper spatial analysis.</p>
</div>
<div id="add-nta-data" class="section level2">
<h2>add nta data</h2>
<pre class="r"><code>df$X_COORD_CD &lt;- as.numeric(df$X_COORD_CD)
df$Y_COORD_CD &lt;- as.numeric(df$Y_COORD_CD)

# Convert to sf object
df_sf &lt;- st_as_sf(df, coords = c(&quot;X_COORD_CD&quot;, &quot;Y_COORD_CD&quot;), crs = 2263)

# Read neighborhood shapefile
nta &lt;- st_read(&quot;./data/nynta2020_24d/nynta2020.shp&quot;)</code></pre>
<pre><code>## Reading layer `nynta2020&#39; from data source 
##   `/Users/wangmingyin/Desktop/data science 1/Final_website/data/nynta2020_24d/nynta2020.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 262 features and 11 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 913175.1 ymin: 120128.4 xmax: 1067383 ymax: 272844.3
## Projected CRS: NAD83 / New York Long Island (ftUS)</code></pre>
<pre class="r"><code># Transform CRS if necessary
nta &lt;- st_transform(nta, crs = st_crs(df_sf))

# Perform spatial join
df_joined &lt;- st_join(df_sf, nta, left = TRUE)

# Add neighborhood information to your original data frame
df$NTA &lt;- df_joined$NTAName  # Adjust based on actual column name</code></pre>
</div>
<div id="add-2010-nta-data" class="section level2">
<h2>add 2010 nta data</h2>
<pre class="r"><code>df$X_COORD_CD &lt;- as.numeric(df$X_COORD_CD)
df$Y_COORD_CD &lt;- as.numeric(df$Y_COORD_CD)

# Convert to sf object
df_sf &lt;- st_as_sf(df, coords = c(&quot;X_COORD_CD&quot;, &quot;Y_COORD_CD&quot;), crs = 2263)

# Read neighborhood shapefile
neighborhoods_2010 &lt;- st_read(&quot;./data/nynta2010_24d/nynta2010.shp&quot;)</code></pre>
<pre><code>## Reading layer `nynta2010&#39; from data source 
##   `/Users/wangmingyin/Desktop/data science 1/Final_website/data/nynta2010_24d/nynta2010.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 195 features and 7 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 913175.1 ymin: 120128.4 xmax: 1067383 ymax: 272844.3
## Projected CRS: NAD83 / New York Long Island (ftUS)</code></pre>
<pre class="r"><code># Transform CRS if necessary
neighborhoods_2010 &lt;- st_transform(neighborhoods_2010, crs = st_crs(df_sf))

# Perform spatial join
df_joined &lt;- st_join(df_sf, neighborhoods_2010, left = TRUE)

# Add neighborhood information to your original data frame
df$NTA_2010 &lt;- df_joined$NTAName  # Adjust based on actual column name</code></pre>
<p>converts the shooting data into a spatial format, joins it with
neighborhood boundaries (both 2020 and 2010 shapefiles), and adds
additional neighborhood attributes for deeper spatial analysis.</p>
</div>
<div id="add-time-information" class="section level2">
<h2>add time information</h2>
<p>for future study, i need to add variables related to date and time of
the gunshot incidence.</p>
<div id="decide-whether-the-date-of-shooting-is-national-holiday"
class="section level3">
<h3>decide whether the date of shooting is national holiday</h3>
<pre class="r"><code>df$OCCUR_DATE &lt;- as.Date(df$OCCUR_DATE, format = &quot;%m/%d/%Y&quot;)

# Define the range of years, handling NA values
years &lt;- seq(
  year(min(df$OCCUR_DATE, na.rm = TRUE)),
  year(max(df$OCCUR_DATE, na.rm = TRUE)),
  by = 1
)
us_holidays = holidayNYSE(years)
us_holidays = as.Date(us_holidays)
# Add a new column indicating whether the date is a holiday, year and month information of a date
df = df %&gt;%
  mutate(
    Is_Holiday = OCCUR_DATE %in% us_holidays,
    Year = year(OCCUR_DATE),
    Month = month(OCCUR_DATE)
  )</code></pre>
<p>The code handles holidays by using the <code>holidayNYSE()</code>
function to determine which dates are public holidays. A new column
(<code>Is_Holiday</code>) is added to indicate if each incident occurred
on a holiday. The dataset is also enriched by extracting year and month
information from the <code>OCCUR_DATETIME</code> to facilitate temporal
trend analysis.</p>
</div>
<div
id="decide-whether-the-sky-is-dark-at-the-shooting-time-using-the-dawn-and-dusk-time"
class="section level3">
<h3>decide whether the sky is dark at the shooting time, using the dawn
and dusk time:</h3>
<pre class="r"><code>df$OCCUR_DATE &lt;- as.character(df$OCCUR_DATE)
df$OCCUR_TIME &lt;- as.character(df$OCCUR_TIME)

# Combine OCCUR_DATE and OCCUR_TIME into a single datetime string
datetime_str &lt;- paste(df$OCCUR_DATE, df$OCCUR_TIME)

# Parse datetime using lubridate
df$OCCUR_DATETIME &lt;- ymd_hms(datetime_str, tz = &quot;America/New_York&quot;)
# Extract date from OCCUR_DATETIME
df$DATE &lt;- as.Date(df$OCCUR_DATETIME)

# Get unique dates
unique_dates &lt;- unique(df$DATE)
latitude &lt;- 40.7128
longitude &lt;- -74.0060
# Calculate dawn and dusk times
sun_times &lt;- getSunlightTimes(
  date = unique_dates,
  lat = latitude,
  lon = longitude,
  keep = c(&quot;dawn&quot;, &quot;dusk&quot;),
  tz = &quot;America/New_York&quot;
)

# Merge with the original dataframe
df &lt;- df %&gt;%
  left_join(sun_times[, c(&quot;date&quot;, &quot;dawn&quot;, &quot;dusk&quot;)], by = c(&quot;DATE&quot; = &quot;date&quot;))

# Determine if the sky is dark considering twilight
df &lt;- df %&gt;%
  mutate(
    Sky_Is_Dark = OCCUR_DATETIME &lt; dawn | OCCUR_DATETIME &gt;= dusk
  )
df &lt;- df %&gt;%
  select(-DATE, -dawn, -dusk)</code></pre>
<p>The code calculates dawn and dusk times for each unique date in the
dataset. Using NYC’s coordinates (<code>latitude</code> and
<code>longitude</code>), the <code>getSunlightTimes()</code> function
generates dawn and dusk times for each day, which are then merged with
the original dataset. A new column (<code>Sky_Is_Dark</code>) is added
to indicate whether the shooting incident occurred during dark
conditions, defined as before dawn or after dusk.</p>
</div>
</div>
<div id="adding-total-population-data-of-each-nta"
class="section level2">
<h2>adding total population data of each NTA</h2>
<pre class="r"><code>popu &lt;- suppressWarnings(
  read_excel(&quot;./data/nyc_detailed-race-and-ethnicity-data_2020_core-geographies.xlsx&quot;, 
             sheet = 1,
             range = &quot;A4:I2599&quot;,
             col_types = c(&quot;numeric&quot;, &quot;text&quot;, &quot;text&quot;, &quot;text&quot;, &quot;numeric&quot;, &quot;text&quot;, &quot;text&quot;, &quot;numeric&quot;, &quot;numeric&quot;)) |&gt;
    filter(`Orig Order` &gt;= 2334 &amp; `Orig Order` &lt;= 2595) |&gt;
    select(GeoName, NTAType, Pop) |&gt;
    rename(Total_population = Pop)
)

df &lt;- df |&gt;
  left_join(popu, by = c(&quot;NTA&quot; = &quot;GeoName&quot;)) |&gt;
  mutate(
    NTAType = case_when(
      NTAType == 0 ~ &quot;Residential&quot;,
      NTAType == 9 ~ &quot;Park&quot;,
      NTAType == 8 ~ &quot;Airport&quot;,
      NTAType == 7 ~ &quot;Cemetery&quot;,
      NTAType == 6 ~ &quot;Other Special Areas&quot;,
      NTAType == 5 ~ &quot;Rikers Island&quot;,
      is.na(NTAType) ~ &quot;Unknown&quot;)
  )</code></pre>
<p>reads population data from an Excel file
(<code>nyc_detailed-race-and-ethnicity-data_2020_core-geographies.xlsx</code>).
The data is filtered to include relevant rows for specific neighborhoods
and selects columns such as <code>GeoName</code>, <code>NTAType</code>,
and <code>Pop</code>. After renaming the <code>Pop</code> column to
<code>Total_population</code>, this data is merged with the original
dataset (<code>df</code>). The <code>NTAType</code> values are mapped to
descriptive names like “Residential”, “Park”, or “Airport” to better
understand the types of neighborhoods involved.</p>
</div>
<div id="adding-cdta-data" class="section level2">
<h2>adding cdta data</h2>
<pre class="r"><code>df$X_COORD_CD &lt;- as.numeric(df$X_COORD_CD)
df$Y_COORD_CD &lt;- as.numeric(df$Y_COORD_CD)

df_sf &lt;- st_as_sf(df, coords = c(&quot;X_COORD_CD&quot;, &quot;Y_COORD_CD&quot;), crs = 2263)

cdta &lt;- st_read(&quot;./data/nycdta2020_24d/nycdta2020.shp&quot;)</code></pre>
<pre><code>## Reading layer `nycdta2020&#39; from data source 
##   `/Users/wangmingyin/Desktop/data science 1/Final_website/data/nycdta2020_24d/nycdta2020.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 71 features and 8 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 913175.1 ymin: 120128.4 xmax: 1067383 ymax: 272844.3
## Projected CRS: NAD83 / New York Long Island (ftUS)</code></pre>
<pre class="r"><code>cdta &lt;- st_transform(cdta, crs = st_crs(df_sf))

df_joined &lt;- st_join(df_sf, cdta, left = TRUE)

df$CDTA &lt;- df_joined$CDTA2020

df$CDTA &lt;- gsub(&quot;([A-Z]{2})(\\d{2})&quot;, &quot;\\1 \\2&quot;, df$CDTA)</code></pre>
<p>Similar to adding NTA data</p>
</div>
<div id="add-poverty" class="section level2">
<h2>add poverty</h2>
<pre class="r"><code>neighborhood_poverty &lt;- read.csv(&quot;./data/neighborhood_poverty.csv&quot;)

# Select specific columns from neighborhood_poverty
neighborhood_poverty_selected &lt;- neighborhood_poverty %&gt;% 
  filter(TimePeriod == &#39;2017-21&#39;) %&gt;% 
  filter(GeoType == &#39;NTA2020&#39; ) %&gt;% 
  select(Number, Percent, Geography)
# Merge the dataframes on &#39;NTA&#39; and &#39;Geography&#39;, keeping all information from data_processing
df_poverty &lt;- left_join(df, neighborhood_poverty_selected, by = c(&quot;NTA&quot; = &quot;Geography&quot;))

# Rename columns after merging
df_poverty &lt;- df_poverty %&gt;% 
  rename(Number_poverty = Number, Percent_poverty = Percent)</code></pre>
<p>filters the poverty data for the relevant time period (2017-21) and
geographic type (<code>NTA2020</code>), selects specific columns, and
merges this poverty data with the shooting incident dataset.</p>
</div>
<div id="add-education" class="section level2">
<h2>add education</h2>
<pre class="r"><code>neighborhood_education=read.csv(&quot;./data/graduated_high_school.csv&quot;)
neighborhood_education_selected &lt;- neighborhood_education %&gt;% 
  filter(TimePeriod == &#39;2017-21&#39;) %&gt;% 
  filter(GeoType == &#39;NTA2020&#39; ) %&gt;% 
  select(Number, Percent, Geography)
# Merge the dataframes on &#39;NTA&#39; and &#39;Geography&#39;, keeping all information from data_processing
df_education &lt;- left_join(df_poverty, neighborhood_education_selected, by = c(&quot;NTA&quot; = &quot;Geography&quot;))

# Rename columns after merging
df_education &lt;- df_education %&gt;% 
  rename(Number_education = Number, Percent_education = Percent)
# filter between 2017 and 2023
df_education$OCCUR_DATE &lt;- as.Date(df_education$OCCUR_DATE, format = &quot;%Y-%m-%d&quot;)

# Filter the incidents that happened between 2017 and 2023
df_education &lt;- df_education %&gt;% 
  filter(OCCUR_DATE &gt;= as.Date(&quot;2017-01-01&quot;) &amp; OCCUR_DATE &lt;= as.Date(&quot;2023-12-31&quot;))</code></pre>
<p>filters the education data for the relevant time period (2017-21) and
geographic type (<code>NTA2020</code>), selects specific columns, and
merges this poverty data with the shooting incident dataset.</p>
</div>
<div id="compute-incident-rate" class="section level2">
<h2>compute incident rate</h2>
<pre class="r"><code>#add a column that shows the shooting incident rate of NTAs in that year
df_education &lt;- df_education %&gt;%
  group_by(NTA, Year) %&gt;%
  mutate(incident_rate_by_year_nta = (n() / Total_population)*100) %&gt;%
  ungroup()

#add a column that shows the shooting incident rate of boroughs in that year
boro_population &lt;- df_education %&gt;%
  group_by(BORO, Year) %&gt;%
  summarise(total_population_boro = sum(Total_population, na.rm = TRUE)) %&gt;%
  ungroup()</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;BORO&#39;. You can override using the
## `.groups` argument.</code></pre>
<pre class="r"><code>df_education &lt;- df_education %&gt;%
  left_join(boro_population, by = c(&quot;BORO&quot;, &quot;Year&quot;)) %&gt;%
  group_by(BORO, Year) %&gt;%
  mutate(incident_rate_by_year_boro = (n() / total_population_boro)*100) %&gt;%
  ungroup()

#Rename a column
df_education &lt;- df_education %&gt;%
  rename(Total_population_nta = Total_population)

write.csv(df_education, &quot;data_final.csv&quot;, row.names = FALSE)</code></pre>
<p>calculates shooting incident rates for both Neighborhood Tabulation
Areas (NTAs) and boroughs by year. For each NTA, the incident rate is
calculated as the number of incidents per total population
(<code>incident_rate_by_year_nta</code>). Similarly, the total
population for each borough is calculated, and the shooting incident
rate for each borough is computed
(<code>incident_rate_by_year_boro</code>).</p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
